<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{../../css/default.css}"/>
    <link rel="stylesheet" th:href="@{../../css/user/common.css}">
    <link rel="stylesheet" th:href="@{../../css/user/comment.css}">
    <link rel="stylesheet" th:href="@{/css/user/board/free.css}">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>

    <div th:each="free: ${ PostAndMemberDTO }">
        <title th:text="${free.postTitle}"></title>
    </div>
</head>
<body>
    <div th:replace="user/layout/header.html"></div>
    <!--게시글 영역-->

    <div class="free_list_content" style="flex-direction: column; align-items: center;">
        <article>
        <div th:each="free: ${ PostAndMemberDTO }" >
            <div class="category_data">
                <p class="mainCategory" th:text="${free.mainCategory}"></p>
                <p class="category_line">|</p>
                <p class="subCategory" th:text=" ${free.subCategory}"></p>
            </div>
            <div class="title_viewCount">
                <p class="free_detail_title" th:text="${free.postTitle}"></p>
                <p class="viewCount" th:text="|조회수 ${free.viewCount}|"></p>
            </div>
            <div class="free_nickname_date">
                <p class="free_nickname" th:text="${free.member.nickname}"></p>
                <p class="free_date" th:text="${ #dates.format(free.postDate, 'yyyy.MM.dd') }"></p>
            </div>
            <hr class="content_line">
            <p class="free_content" th:text="${free.postContext}"></p>
            <hr class="content_line">
        <!--댓글 영역-->
<!--            <p class="comment">댓글ASDFASDFASD</p>-->
        <table>
            <tr th:each="cmt : ${comments}">
                <td th:text="${cmt.comment}"></td>
                <td th:text="${cmt.nickname}"></td>
                <td th:text="${#temporals.format(cmt.modifiedAt, 'yyyy-MM-dd HH:mm')}"></td>
            </tr>
<!--            <form>-->
<!--                <div>-->
<!--                    <label for="comment">댓글 작성</label>-->
<!--                    <textarea class="form-control" id="comment" rows="1"></textarea>-->
<!--                </div>-->
<!--                <button type="button">등록</button>-->
<!--            </form>-->
        </table>
        <hr class="content_line">
        <div class="detail_buttons">
            <button class="detail_button" type="button" th:if="${free.subCategory.equals('예신')}" th:onclick="|location.href='@{/board/yesinmodify(id=${free.postCode})}'|">수정하기</button>
            <button class="detail_button" type="button" th:if="${free.subCategory.equals('예랑')}" th:onclick="|location.href='@{/board/yerangmodify(id=${free.postCode})}'|">수정하기</button>
            <form th:action="@{/board/freedelete(id=${free.postCode})}" method="post">
                <input type="hidden" th:value="${free.subCategory}" name="subCategory">
                <input type="hidden" th:value="${free.postCode}" name="postCode">
                <button class="detail_delete_button" type="submit">삭제하기</button>
            </form>
        </div>
        </div>
        </article>

        <!-- 등록된 댓글 영역 -->
        <div class="registered_comment_box">
            <div class="comment_top_sec">
                <p class="comment_sec_tit">댓글</p>
                <div class="filter_box filter_btn inactive">
                    <p><span class="filter_txt">정렬</span><span class="filter_mark">▼</span></p>
                    <ul class="filter_list">
                        <li>최신순</li>
                        <li>등록순</li>
                    </ul>
                </div>
            </div>

            <ul class="comment_list">
                <li th:each="cmt : ${comments}">
                    <div class="comment_inner_box">
                    <span class="comment_profile_img">
                        <img th:src="@{/images/common/icon_user_profile.svg}" alt="user profile icon">
                    </span>

                        <!-- 기본 댓글 레이아웃 -->
                        <div class="comment_txt_box">
                            <div class="comment_txt_top">
                                <p>
                                    <span class="comment_nickname" th:text="${cmt.nickname}">스드메의문단속</span>
                                    <span class="comment_date" th:text="${#temporals.format(cmt.modifiedAt, 'yyyy-MM-dd HH:mm')}">2024-04-30</span>
                                </p>
                            </div>
                            <p class="comment_context" th:text="${cmt.comment}">그게 마음처럼 쉽지 않더라고요 의견 조율하고 맞춰도 잘안되더라고요 그래도 잘 상의해서 해결하다보면 될겁니다!</p>
                        </div>

                    </div>
                </li>

                <!-- 로그인한 회원이 등록한 댓글 수정 레이아웃 -->
                <li>
                    <div class="comment_inner_box">
                <span class="comment_profile_img">
                  <img th:src="@{/images/common/icon_user_profile.svg}" alt="user profile icon">
                </span>
                        <div class="comment_txt_box">
                            <div class="comment_txt_top">
                                <p>
                                    <span class="comment_nickname">스드메의문단속</span>
                                    <span class="comment_date">2024-04-30</span>
                                </p>
                                <ul class="comment_btn_list">
                                    <li class="modify_comment_btn">수정</li>
                                    <li>|</li>
                                    <li class="delete_comment_btn">삭제</li>
                                </ul>
                            </div>
                            <p class="comment_context">그게 마음처럼 쉽지 않더라고요 의견 조율하고 맞춰도 잘안되더라고요 그래도 잘 상의해서 해결하다보면 될겁니다!</p>
                            <div class="schedule_txt_box">
                                <textarea class="schedule_contxt_box" placeholder="내용을 입력하세요" maxlength="100"></textarea>
                                <span class="txt_count eng"><span class="txt_counted">0</span>/100</span>
                                <div class="schedule_btn_list">
                                    <button class="cancel_btn cancel_register" type="button">취소</button>
                                    <button class="register_btn register_modified_comment_btn" type="button">등록</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="comment_inner_box">
                <span class="comment_profile_img">
                  <img th:src="@{/images/common/icon_user_profile.svg}" alt="user profile icon">
                </span>
                        <div class="comment_txt_box">
                            <div class="comment_txt_top">
                                <p>
                                    <span class="comment_nickname">스드메의문단속</span>
                                    <span class="comment_date">2024-04-30</span>
                                </p>
                                <ul class="comment_btn_list">
                                    <li class="modify_comment_btn">수정</li>
                                    <li>|</li>
                                    <li class="delete_comment_btn">삭제</li>
                                </ul>
                            </div>
                            <p class="comment_context">그게 마음처럼 쉽지 않더라고요 의견 조율하고 맞춰도 잘안되더라고요 그래도 잘 상의해서 해결하다보면 될겁니다!</p>
                            <div class="schedule_txt_box">
                                <textarea class="schedule_contxt_box" placeholder="내용을 입력하세요" maxlength="100"></textarea>
                                <span class="txt_count eng"><span class="txt_counted">0</span>/100</span>
                                <div class="schedule_btn_list">
                                    <button class="cancel_btn cancel_register" type="button">취소</button>
                                    <button class="register_btn register_modified_comment_btn" type="button">등록</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>

            <!-- 댓글 입력 영역 -->
            <div class="comment_input_box">
            <span class="comment_profile_img">
              <img th:src="@{/images/common/icon_user_profile.svg}" alt="user profile icon">
            </span>

                <!-- 댓글 입력 input -->
                <form class="comment_input_area">
                    <div class="schedule_tit_box"><input type="text" class="schedule_tit" maxlength="100" placeholder="내용을 입력하세요"><span class="tit_count eng"><span class="tit_counted">0</span>/100</span></div>
                    <span class="register_btn register_comment_btn">등록</span>
                </form>


            </div>
        </div>
    </div>
    <div th:replace="user/layout/footer.html"></div>
    <!--댓글 관련 script-->
    <!--<script>-->
    <!--    const bno = `${postCode}`;-->
    <!--    const URL = '/user/board/freeDetail';-->
    <!--    function showReplies(pageNum = 1) {-->

    <!--        fetch(URL + '?boardNo=' + bno + '&pageNum=' + pageNum)-->
    <!--            .then(res => res.json())-->
    <!--            .then(replyMap => {-->
    <!--                makeReplyDOM(replyMap);-->
    <!--            });-->
    <!--    }-->
    <!--</script>-->

    <!-- 댓글 삭제 시 재확인 팝업창 -->
    <div class="pop_bg"></div>
    <div class="pop_cont selective">
        <span class="pop_icon"><img th:src="@{/images/common/icon_group_modal_bang.svg}" alt="popup icon image"></span>
        <p>해당 댓글을 삭제하시겠습니까?</p>
        <ul class="pop_btn_list">
            <li class="cancel_btn execute_delete_btn" data-comment-index=""><span>삭제</span></li>
            <li class="confirm_btn">취소</li>
        </ul>
    </div>

    <!-- 댓글 등록시 입력내용이 없는 경우 , 팝업창 -->
    <div class="pop_cont no_text">
        <span class="pop_icon"><img th:src="@{/images/common/icon_group_modal_bang.svg}" alt="popup icon image"></span>
        <p>등록 내용이 없습니다.<br>다시 입력해주세요.</p>
        <span class="pop_btn confirm_btn">확인</span>
    </div>
    <script th:src="@{/js/common.js}"></script>
    <script th:inline="javascript">

        //댓글 삭제 재확인 팝업창내 삭제 버튼 클릭시, 재확인 팝업창 활성화
        $(document).on('click', ".delete_comment_btn", (e) => {
            const index = $(e.target).parents(".comment_inner_box").closest('li').index();
            $(".execute_delete_btn").attr('data-comment-index', index);
            $(".pop_bg, .pop_cont.selective").addClass("active");
            $('html, body').addClass('fixed');
        })

        //댓글 등록시 등록내용이 없는 경우


        $(".pop_btn_list > li, .pop_btn").click((e) => {
            const scrollTop = $(window).scrollTop(); // 스크롤 위치
            if ($(e.target).closest("li").hasClass("cancel_btn")) {//댓글 삭제 버튼을 클릭시
                console.log("댓글 삭제");
            } else {//댓글 삭제 취소 버튼을 클릭시
                console.log("댓글 삭제 취소");
            }
            $(".pop_bg, .pop_cont").removeClass("active"); // 팝업창/팝업배경 비활성화
            $(window).scrollTop(scrollTop);
            $('html, body').removeClass('fixed');
        })

        // clickDeleteComment();

        // 댓글 등록 HTML태그 저장 변수
        const commentListItem = (nickname, date, context) => `<li>
              <div class="comment_inner_box">
                <span class="comment_profile_img">
                  <img src="/images/common/icon_user_profile.svg" alt="user profile icon">
                </span>
                <div class="comment_txt_box">
                  <div class="comment_txt_top">
                    <p>
                      <span class="comment_nickname">${nickname}</span>
                      <span class="comment_date">${date}</span>
                    </p>
                    <ul class="comment_btn_list">
                      <li class="modify_comment_btn">수정</li>
                      <li>|</li>
                      <li class="delete_comment_btn">삭제</li>
                    </ul>
                  </div>
                  <p class="comment_context">${context}</p>
                  <div class="schedule_txt_box">
                    <textarea class="schedule_contxt_box" placeholder="내용을 입력하세요" maxlength="100">${context}</textarea>
                    <span class="txt_count eng"><span class="txt_counted">0</span>/100</span>
                    <div class="schedule_btn_list">
                      <button class="cancel_btn cancel_register" type="button">취소</button>
                      <button class="register_btn register_modified_comment_btn" type="button">등록</button>
                    </div>
                  </div>
                </div>
              </div>
            </li>`;

        //수정된 댓글 저장 변수
        let modifiedComment = '';

        // 정렬 버튼 클릭시,
        $('.filter_btn').click(() => {
            $(".filter_btn").toggleClass('active').find(".filter_list").stop().slideToggle(); // 클릭할때마다 활성/비활성화 자동설정
        })

        // 정렬 리스트 내 버튼 클릭시, 해당 정렬 내용으로 변경
        $(".filter_list li").click((e) => {
            const filterSelected = $(e.target).text();
            $(".filter_txt").text(filterSelected);
        })

        // 댓글 등록 버튼 클릭시,
        $(".register_comment_btn").click((e) => {
            const today = new Date(+new Date() + 3240 * 10000).toISOString().split("T")[0]; // 오늘 날짜 yyyy-mm-dd형식

            const context = $(e.target).siblings('.schedule_tit_box').find('input').val();
            if ($(e.target).siblings('.schedule_tit_box').find('input').val() == null || $(e.target).siblings('.schedule_tit_box').find('input').val() == '') { // 댓글 입력내용이 빈칸이거나 null일경우
                $(".pop_bg, .pop_cont.no_text").addClass("active");
                $('html, body').addClass('fixed');
            } else { // 입력 내용이 있는 경우
                $(".comment_list").prepend(commentListItem('스드메의문단속', today, context)); // 닉네임, 오늘날짜, 댓글내용 매개변수 설정
                $(e.target).siblings('.schedule_tit_box').find('input').val(null); // 등록 후 input 영역 내용 초기화
                $(e.target).siblings('.schedule_tit_box').find('.tit_counted').text(0); // 댓글 등록 후 글자수 초기화
            }

        })

        // 댓글 수정 버튼 클릭시,
        $(document).on("click", ".modify_comment_btn", (e) => {
            let registeredComment = $(e.target).parents(".comment_txt_box").find(".comment_context").text(); // 등록된 댓글
            let registeredCommentLength = registeredComment.length; //등록된 댓글 길이

            $(e.target).parents(".comment_txt_box").find('.schedule_contxt_box').text(registeredComment);//해당 댓글의 입력된 내용으로 textarea 내용 변경
            $(e.target).parents(".comment_txt_box").find('.txt_counted').text(registeredCommentLength);//해당 댓글 텍스트 길이로 내용 변경
            $(e.target).parents(".comment_txt_box").find('.schedule_txt_box').toggleClass('active');
        });

        // 댓글 수정 취소 버튼 클릭시,
        $(document).on("click", ".cancel_register", (e) => {
            let registeredComment = $(e.target).parents(".comment_txt_box").find(".comment_context").text(); // 등록된 댓글
            let registeredCommentLength = registeredComment.length; //등록된 댓글 길이
            $(e.target).parents(".comment_txt_box").find('.schedule_contxt_box').val(registeredComment);//해당 댓글의 입력된 내용으로 textarea 내용 변경
            $(e.target).parents(".comment_txt_box").find('.txt_counted').text(registeredCommentLength);//해당 댓글 텍스트 길이로 내용 변경
            $(e.target).parents(".comment_txt_box").find('.schedule_txt_box').toggleClass('active');
        });


        // 수정 후 댓글 등록 버튼 클릭시,
        $(document).on("click", '.register_modified_comment_btn', (e) => {
            countedText = $(e.target).parents(".comment_txt_box").find('.txt_counted').text();

            if(countedText != 0){ // 수정 내용의 입력 길이가 0인 아니라면 - 입력 내용 존재
                $(e.target).parents(".comment_txt_box").find('.comment_context').text(modifiedComment);
                $(e.target).parents(".comment_txt_box").find('.txt_counted').text('0');
                $(e.target).parents(".comment_txt_box").find('.schedule_txt_box').removeClass('active');
            } else { // 수정 내용의 입력 길이가 0이라면 - 입력 내용 없음
                $(".pop_bg, .pop_cont.no_text").addClass("active"); // 입력 내용 없다는 팝업창 알림 활성화
                $('html, body').addClass('fixed'); // 웹 페이지 스크롤 기능 제거
            }

        })

        //댓글 입력시 입력시 텍스트 길이 실시간 반영
        $(document).on('input', '.schedule_tit', (e) => {
            $(".tit_counted").text(e.target.value.length);
        })

        //스케쥴 내용 입력시 텍스트 길이 실시간 반영
        $(document).on('input', '.schedule_contxt_box', (e) => {
            $(".txt_counted").text(e.target.value.length);
        })

        //댓글 삭제 버튼 클릭시,
        $(document).on('click', '.execute_delete_btn', () => {
            const index = $(".execute_delete_btn").attr('data-comment-index');
            $(".comment_list > li").eq(index).remove();
        })
    </script>
</body>
</html>